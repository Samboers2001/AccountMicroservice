steps:
  # Build and push Docker image for the account service
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "gcr.io/ordering-system-404411/accountmicroservice:$COMMIT_SHA"
      - "."

  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/ordering-system-404411/accountmicroservice:$COMMIT_SHA"

  # Access the id_github file from Secret Manager, and setup SSH
  - name: 'gcr.io/cloud-builders/git'
    secretEnv: ['SSH_KEY']
    entrypoint: 'bash'
    args:
    - -c
    - |
      echo "$$SSH_KEY" >> /root/.ssh/id_rsa
      chmod 400 /root/.ssh/id_rsa
      cp known_hosts.github /root/.ssh/known_hosts
    volumes:
    - name: 'ssh'
      path: /root/.ssh

  # Clone the repository
  - name: 'gcr.io/cloud-builders/git'
    args:
    - clone
    - --recurse-submodules
    - git@github.com:Samboers2001/K8S
    volumes:
    - name: 'ssh'
      path: /root/.ssh

availableSecrets:
  secretManager:
  - versionName: projects/264096596366/secrets/github-ssh-key/versions/1
    env: 'SSH_KEY'

 
 
  - name: "gcr.io/cloud-builders/kubectl"
    args:
      - "apply"
      - "-f"
      - "./K8S/GKE/account-database/account-gke-pvc.yaml" # Apply database PVC
      - "./K8S/GKE/account-database/mariadb-account-secret.yaml" # Apply database Secret
      - "./K8S/GKE/account-database/mariadb-account-depl.yaml" # Apply database Deployment and Service
      - "./K8S/GKE/account-service/account-depl.yaml" # Apply account service Deployment, Service, and PVC


logsBucket: "gs://accountci-logs-bucket"
